---
phase: 02-protocol-parsing
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - internal/protocol/server.go
  - internal/protocol/helpers.go
  - internal/protocol/vless.go
  - internal/protocol/vmess.go
  - internal/protocol/trojan.go
  - internal/protocol/shadowsocks.go
  - internal/protocol/parse.go
  - internal/protocol/parse_test.go
  - internal/protocol/vless_test.go
  - internal/protocol/vmess_test.go
  - internal/protocol/trojan_test.go
  - internal/protocol/shadowsocks_test.go
autonomous: true
requirements:
  - PROT-01
  - PROT-02
  - PROT-03
  - PROT-04

must_haves:
  truths:
    - "A vless:// URI with uuid, host, port, query params, and fragment parses into a Server struct with all fields populated correctly"
    - "A vmess:// URI with base64-encoded JSON (padded or unpadded, standard or URL-safe) parses into a Server struct with correct address, port, UUID, and transport settings"
    - "A trojan:// URI with password, host, port, and TLS params parses into a Server struct with password extracted from userinfo"
    - "An ss:// URI in both SIP002 base64 format and AEAD-2022 plaintext format parses into a Server struct with correct method and password"
    - "ParseURI dispatches to the correct protocol parser based on scheme prefix"
    - "Malformed URIs produce descriptive error messages identifying what is wrong, never panics"
    - "URIs without a #fragment fall back to address:port as the server name"
    - "IPv6 addresses in brackets parse correctly with correct host and port separation"
  artifacts:
    - path: "internal/protocol/server.go"
      provides: "Server struct, Protocol enum, shared types"
      contains: "type Server struct"
    - path: "internal/protocol/parse.go"
      provides: "ParseURI scheme dispatcher"
      exports: ["ParseURI"]
    - path: "internal/protocol/vless.go"
      provides: "VLESS URI parser"
      exports: ["ParseVLESS"]
    - path: "internal/protocol/vmess.go"
      provides: "VMess URI parser with base64+JSON handling"
      exports: ["ParseVMess"]
    - path: "internal/protocol/trojan.go"
      provides: "Trojan URI parser"
      exports: ["ParseTrojan"]
    - path: "internal/protocol/shadowsocks.go"
      provides: "Shadowsocks SIP002 URI parser"
      exports: ["ParseShadowsocks"]
    - path: "internal/protocol/helpers.go"
      provides: "Shared helpers: defaultString, decodeBase64, jsonFlexInt"
      exports: ["decodeBase64"]
    - path: "internal/protocol/parse_test.go"
      provides: "Table-driven tests for ParseURI dispatcher"
      min_lines: 30
    - path: "internal/protocol/vless_test.go"
      provides: "VLESS parser tests including edge cases"
      min_lines: 50
    - path: "internal/protocol/vmess_test.go"
      provides: "VMess parser tests including base64 variants"
      min_lines: 50
    - path: "internal/protocol/trojan_test.go"
      provides: "Trojan parser tests"
      min_lines: 40
    - path: "internal/protocol/shadowsocks_test.go"
      provides: "Shadowsocks parser tests including SIP002 dual format"
      min_lines: 50
  key_links:
    - from: "internal/protocol/parse.go"
      to: "internal/protocol/vless.go"
      via: "ParseURI dispatches to ParseVLESS for vless:// scheme"
      pattern: "ParseVLESS\\(uri\\)"
    - from: "internal/protocol/parse.go"
      to: "internal/protocol/vmess.go"
      via: "ParseURI dispatches to ParseVMess for vmess:// scheme"
      pattern: "ParseVMess\\(uri\\)"
    - from: "internal/protocol/parse.go"
      to: "internal/protocol/trojan.go"
      via: "ParseURI dispatches to ParseTrojan for trojan:// scheme"
      pattern: "ParseTrojan\\(uri\\)"
    - from: "internal/protocol/parse.go"
      to: "internal/protocol/shadowsocks.go"
      via: "ParseURI dispatches to ParseShadowsocks for ss:// scheme"
      pattern: "ParseShadowsocks\\(uri\\)"
    - from: "internal/protocol/vmess.go"
      to: "internal/protocol/helpers.go"
      via: "VMess parser uses decodeBase64 for base64 fallback chain"
      pattern: "decodeBase64\\("
---

<objective>
Implement the Server struct and all four protocol URI parsers (VLESS, VMess, Trojan, Shadowsocks) with comprehensive table-driven tests using TDD.

Purpose: These parsers are the data entry point for the entire application -- every server the user connects to begins as a URI string that must be correctly parsed into a normalized Server struct. Correctness here prevents cascading failures in connection, display, and persistence.

Output: `internal/protocol/` package with Server struct, 4 protocol parsers, ParseURI dispatcher, shared helpers, and full test coverage for all protocols including edge cases.
</objective>

<execution_context>
@/Users/lee/.claude/get-shit-done/workflows/execute-plan.md
@/Users/lee/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-protocol-parsing/02-RESEARCH.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
@.planning/phases/01-foundation/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Server struct, helpers, and failing tests for all parsers</name>
  <files>
    internal/protocol/server.go
    internal/protocol/helpers.go
    internal/protocol/vless.go
    internal/protocol/vmess.go
    internal/protocol/trojan.go
    internal/protocol/shadowsocks.go
    internal/protocol/parse.go
    internal/protocol/parse_test.go
    internal/protocol/vless_test.go
    internal/protocol/vmess_test.go
    internal/protocol/trojan_test.go
    internal/protocol/shadowsocks_test.go
  </files>
  <action>
RED phase: Create the full test suite and minimal stubs that compile but fail.

**1. Create `internal/protocol/server.go`:**
- Define `Protocol` type as `string` with constants: `ProtocolVLESS`, `ProtocolVMess`, `ProtocolTrojan`, `ProtocolShadowsocks`.
- Define `Server` struct exactly as specified in RESEARCH Pattern 1 (unified flat struct with JSON tags). Fields: ID, Name, Protocol, Address, Port, UUID, Password, AlterID, Encryption, Method, Security, Network, Path, Host, ServiceName, TLS, SNI, ALPN, Fingerprint, AllowInsecure, PublicKey, ShortID, SpiderX, Flow, Type, SubscriptionSource, LatencyMs, LastConnected, AddedAt, RawURI.
- Use `json:"field_name,omitempty"` tags on all optional fields. `ID`, `Name`, `Protocol`, `Address`, `Port`, `AddedAt` are NOT omitempty.
- Import `time` for timestamp fields, `crypto/rand` for UUID generation.
- Add `func NewID() string` that generates a UUID v4 string using `crypto/rand`.

**2. Create `internal/protocol/helpers.go`:**
- `func defaultString(val, fallback string) string` -- returns val if non-empty, else fallback.
- `func decodeBase64(s string) ([]byte, error)` -- tries StdEncoding, RawStdEncoding, URLEncoding, RawURLEncoding in order (RESEARCH Pattern 4). Trims whitespace first.
- `type jsonFlexInt int` with `UnmarshalJSON` method that handles both string `"443"` and number `443` (RESEARCH VMess pitfall 2).

**3. Create parser stubs** (each returns `nil, fmt.Errorf("not implemented")`):
- `internal/protocol/vless.go`: `func ParseVLESS(uri string) (*Server, error)`
- `internal/protocol/vmess.go`: `func ParseVMess(uri string) (*Server, error)`
- `internal/protocol/trojan.go`: `func ParseTrojan(uri string) (*Server, error)`
- `internal/protocol/shadowsocks.go`: `func ParseShadowsocks(uri string) (*Server, error)`
- `internal/protocol/parse.go`: `func ParseURI(uri string) (*Server, error)` dispatcher (RESEARCH Pattern 2), dispatching by scheme prefix.

**4. Create test files with table-driven tests:**

`internal/protocol/vless_test.go` -- Test cases:
- Standard VLESS URI with all common params (type=ws, security=tls, sni, fp, path, host)
- VLESS with REALITY params (security=reality, pbk, sid, spx)
- VLESS with flow=xtls-rprx-vision
- VLESS with gRPC transport (type=grpc, serviceName)
- VLESS with IPv6 address in brackets
- VLESS with no fragment (name defaults to host:port)
- VLESS with empty URI (error)
- VLESS with missing UUID (error)
- VLESS with missing host (error)
- VLESS with invalid port (error)

`internal/protocol/vmess_test.go` -- Test cases:
- Standard VMess URI with padded base64 (ps, add, port as int, id, net=ws, tls)
- VMess with unpadded base64
- VMess with URL-safe base64
- VMess with port as string "443" (jsonFlexInt test)
- VMess with alterId as string "0"
- VMess with missing address (error)
- VMess with invalid base64 (error)
- VMess with invalid JSON (error)
- VMess with zero port (error)
- VMess with no ps field (name defaults to add:port)

`internal/protocol/trojan_test.go` -- Test cases:
- Standard Trojan URI with TLS and SNI
- Trojan with WebSocket transport
- Trojan with gRPC transport
- Trojan with no port (defaults to 443)
- Trojan with REALITY params
- Trojan with no fragment (name defaults to host:port)
- Trojan with empty password (error)
- Trojan with missing host (error)

`internal/protocol/shadowsocks_test.go` -- Test cases:
- SS with base64-encoded method:password (SIP002 legacy/AEAD)
- SS with plaintext method:password (AEAD-2022, e.g., 2022-blake3-aes-128-gcm)
- SS with URL-encoded password containing special chars
- SS with no fragment (name defaults to host:port)
- SS with missing host or port (error)
- SS with un-decodable base64 userinfo and no colon (error)

`internal/protocol/parse_test.go` -- Test cases:
- Each scheme dispatches to correct parser
- Empty URI returns error
- Unsupported scheme (e.g., "http://") returns error
- Whitespace-trimmed URI still parses

For VMess test data: pre-encode test JSON payloads with `base64.StdEncoding.EncodeToString()` in a test helper, so tests are self-contained and readable.

All tests MUST compile but FAIL (stubs return "not implemented").
  </action>
  <verify>
    <automated>cd /Users/lee/vless-terminal && go test ./internal/protocol/ -count=1 -v 2>&1 | head -100</automated>
    <manual>Verify all tests compile and all test functions FAIL (RED phase). No test should pass yet.</manual>
    <sampling_rate>run after this task commits, before next task begins</sampling_rate>
  </verify>
  <done>All test files compile, all tests run and FAIL with "not implemented" errors. Server struct and helpers are complete and correct. Parser stubs exist for all 4 protocols plus dispatcher.</done>
</task>

<task type="auto">
  <name>Task 2: Implement all parsers to pass tests</name>
  <files>
    internal/protocol/vless.go
    internal/protocol/vmess.go
    internal/protocol/trojan.go
    internal/protocol/shadowsocks.go
    internal/protocol/parse.go
  </files>
  <action>
GREEN phase: Implement all parsers to make every test pass.

**1. Implement `ParseVLESS` in `vless.go`:**
- Use `net/url.Parse(uri)` for RFC 3986 parsing.
- Validate scheme is "vless", extract UUID from `u.User.Username()`, host from `u.Hostname()`, port from `u.Port()` via `strconv.Atoi`.
- Extract query params: `type` (default "tcp"), `security` (default "none"), `sni`, `fp`, `pbk`, `sid`, `spx`, `path`, `host`, `serviceName`, `alpn`, `flow`, `encryption`, `allowInsecure` (parse as bool).
- Fragment = name, fallback to `host:port` if empty.
- Generate ID via `NewID()`, set `AddedAt` to `time.Now()`, store `RawURI`.
- Follow RESEARCH VLESS code example exactly.

**2. Implement `ParseVMess` in `vmess.go`:**
- Strip "vmess://" prefix, decode remainder with `decodeBase64` (handles all 4 encoding variants).
- Unmarshal JSON into `vmessJSON` struct (local to file). Use `jsonFlexInt` for `V`, `Port`, `Aid` fields.
- Validate `Add` non-empty, `Port` non-zero.
- Map JSON fields to Server struct: `ps`->Name (fallback add:port), `add`->Address, `port`->Port, `id`->UUID, `aid`->AlterID, `net`->Network (default "tcp"), `type`->Type, `host`->Host, `path`->Path, `tls`->TLS, `sni`->SNI, `alpn`->ALPN, `fp`->Fingerprint. Set Security="auto".
- Follow RESEARCH VMess code example. Handle jsonFlexInt for port/aid strings.

**3. Implement `ParseTrojan` in `trojan.go`:**
- Use `net/url.Parse(uri)` -- nearly identical to VLESS pattern.
- Validate scheme is "trojan", extract password from `u.User.Username()`.
- Default port to 443 if not specified (standard for Trojan).
- Default TLS security to "tls" (not "none" like VLESS -- Trojan uses TLS by default).
- Extract same transport/TLS query params as VLESS.
- Follow RESEARCH Trojan code example.

**4. Implement `ParseShadowsocks` in `shadowsocks.go`:**
- Use `net/url.Parse(uri)`, validate scheme is "ss".
- Detect userinfo format (RESEARCH Pitfall 3):
  - If `u.User.String()` contains ":" -> plaintext `method:password` (AEAD-2022). Use `u.User.Username()` for method, `u.User.Password()` for password.
  - Else -> base64-encoded. Decode with `decodeBase64`, split on ":" to get method and password.
- Fragment = name, fallback to `host:port`.
- Follow RESEARCH Shadowsocks code example.

**5. Verify `ParseURI` dispatcher** in `parse.go`:
- Already implemented in RED phase as dispatcher. Verify it correctly calls each parser.
- Ensure whitespace trimming before scheme detection.

**CRITICAL anti-patterns to avoid (from RESEARCH):**
- Never panic on malformed input -- always return error
- Use `url.Hostname()` and `url.Port()` for IPv6 safety (never split `url.Host` on ":")
- VMess: use jsonFlexInt for port/aid to handle string-encoded numbers
- SS: detect base64 vs plaintext userinfo by checking for colon
  </action>
  <verify>
    <automated>cd /Users/lee/vless-terminal && go test ./internal/protocol/ -count=1 -v 2>&1 | tail -5</automated>
    <manual>Verify ALL tests pass (GREEN phase). Zero failures.</manual>
    <sampling_rate>run after this task commits, before next task begins</sampling_rate>
  </verify>
  <done>All protocol parser tests pass. VLESS, VMess, Trojan, and Shadowsocks URIs parse correctly into Server structs. Malformed URIs return descriptive errors. ParseURI dispatches by scheme. IPv6, missing fragments, base64 variants, and jsonFlexInt edge cases all handled.</done>
</task>

</tasks>

<verification>
1. `go test ./internal/protocol/ -count=1 -v` -- all tests pass
2. `go build ./cmd/azad` -- project still compiles
3. `go vet ./internal/protocol/` -- no vet warnings
4. Verify each parser handles: valid URIs, missing required fields (error), empty fragment (fallback name), IPv6 addresses
5. Verify VMess handles: padded/unpadded base64, URL-safe base64, string-encoded port/aid
6. Verify Shadowsocks handles: base64 userinfo (legacy) and plaintext userinfo (AEAD-2022)
</verification>

<success_criteria>
- All 4 protocol parsers implemented and tested with table-driven tests
- ParseURI dispatcher routes correctly by scheme prefix
- Edge cases covered: IPv6, missing fragments, base64 variants, string-typed JSON numbers, dual SS userinfo formats
- Error messages are descriptive (identify what field is missing/invalid)
- No panics on any malformed input
- `go test` and `go build` both pass cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/02-protocol-parsing/02-01-SUMMARY.md`
</output>
