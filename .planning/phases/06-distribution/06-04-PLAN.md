---
phase: 06-distribution
plan: 04
type: execute
wave: 3
depends_on: ["06-01", "06-03"]
files_modified:
  - .goreleaser.yaml
autonomous: true
requirements:
  - DIST-07

must_haves:
  truths:
    - "GoReleaser generates .deb packages for Debian/Ubuntu with correct metadata and shell completions"
    - "GoReleaser generates .rpm packages for Fedora/RHEL with correct metadata and shell completions"
    - "GoReleaser generates AUR PKGBUILD for Arch Linux with correct install paths"
    - "GoReleaser generates snap manifest with classic confinement for VPN capabilities"
  artifacts:
    - path: ".goreleaser.yaml"
      provides: "nfpms, aurs, and snapcrafts sections for Linux package generation"
      contains: "nfpms:"
  key_links:
    - from: ".goreleaser.yaml nfpms"
      to: "scripts/completions.sh"
      via: "nfpms contents reference completions/ directory generated by before.hooks"
      pattern: "completions/azad"
    - from: ".goreleaser.yaml aurs"
      to: "AUR git repo"
      via: "GoReleaser pushes PKGBUILD to ssh://aur@aur.archlinux.org/azad-bin.git"
      pattern: "azad-bin"
---

<objective>
Add Linux package configuration (nFPM for .deb/.rpm, AUR PKGBUILD, snap) to GoReleaser.

Purpose: Linux users can install azad through their native package manager: `apt install azad` (from .deb), `dnf install azad` (from .rpm), `yay -S azad-bin` (AUR), or `snap install azad` -- each with proper shell completions and metadata.
Output: Extended `.goreleaser.yaml` with nfpms, aurs, and snapcrafts sections.
</objective>

<execution_context>
@/Users/lee/.claude/get-shit-done/workflows/execute-plan.md
@/Users/lee/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-distribution/06-RESEARCH.md
@.planning/phases/06-distribution/06-01-SUMMARY.md
@.planning/phases/06-distribution/06-03-SUMMARY.md
@.goreleaser.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add nFPM configuration for .deb and .rpm packages</name>
  <files>.goreleaser.yaml</files>
  <action>
Add an `nfpms` section to `.goreleaser.yaml` (after the `brews` section added by Plan 03).

**nfpms configuration:**
```yaml
nfpms:
  - id: azad-linux
    package_name: azad
    file_name_template: "{{ .ConventionalFileName }}"
    vendor: leejooy96
    homepage: https://github.com/leejooy96/azad
    maintainer: leejooy96
    description: "Beautiful terminal VPN client — one command to connect to the fastest server"
    license: MIT
    formats:
      - deb
      - rpm
    bindir: /usr/bin
    contents:
      - src: completions/azad.bash
        dst: /usr/share/bash-completion/completions/azad
      - src: completions/azad.zsh
        dst: /usr/share/zsh/vendor-completions/_azad
      - src: completions/azad.fish
        dst: /usr/share/fish/vendor_completions.d/azad.fish
```

**Key points:**
- `file_name_template: "{{ .ConventionalFileName }}"` produces standard package names like `azad_1.0.0_amd64.deb` and `azad-1.0.0-1.x86_64.rpm`
- `bindir: /usr/bin` is the standard location for user-installed binaries on Linux
- `contents` installs shell completions to their standard Linux locations:
  - bash: `/usr/share/bash-completion/completions/azad`
  - zsh: `/usr/share/zsh/vendor-completions/_azad`
  - fish: `/usr/share/fish/vendor_completions.d/azad.fish`
- No runtime dependencies needed (`depends` omitted) since azad is a static binary
- Both .deb and .rpm are generated from the same configuration
  </action>
  <verify>
    <automated>cd /Users/lee/vless-terminal && grep -q "nfpms:" .goreleaser.yaml && grep -q "deb" .goreleaser.yaml && grep -q "rpm" .goreleaser.yaml && grep -q "bash-completion" .goreleaser.yaml && grep -q "vendor-completions" .goreleaser.yaml && echo "PASS"</automated>
  </verify>
  <done>nFPM configuration generates .deb and .rpm packages with correct metadata, binary location, and shell completion installation paths</done>
</task>

<task type="auto">
  <name>Task 2: Add AUR PKGBUILD and snap configuration</name>
  <files>.goreleaser.yaml</files>
  <action>
Add `aurs` and `snapcrafts` sections to `.goreleaser.yaml` (after the `nfpms` section).

**aurs configuration:**
```yaml
aurs:
  - name: azad-bin
    homepage: https://github.com/leejooy96/azad
    description: "Beautiful terminal VPN client — one command to connect to the fastest server"
    maintainers:
      - "leejooy96"
    license: MIT
    private_key: "{{ .Env.AUR_KEY }}"
    git_url: "ssh://aur@aur.archlinux.org/azad-bin.git"
    skip_upload: "{{ if .IsSnapshot }}true{{ end }}"
    package: |-
      install -Dm755 "./azad" "${pkgdir}/usr/bin/azad"
      install -Dm644 "./completions/azad.bash" "${pkgdir}/usr/share/bash-completion/completions/azad"
      install -Dm644 "./completions/azad.zsh" "${pkgdir}/usr/share/zsh/site-functions/_azad"
      install -Dm644 "./completions/azad.fish" "${pkgdir}/usr/share/fish/vendor_completions.d/azad.fish"
```

**Key points for AUR:**
- `name: azad-bin` follows AUR convention for pre-built binary packages (as opposed to `azad` which would build from source)
- `private_key: "{{ .Env.AUR_KEY }}"` uses environment variable for SSH key (stored as CI secret)
- `skip_upload` is conditional: skips during snapshot builds
- `package` block installs the binary and completions with correct Linux permissions (755 for binary, 644 for completions)
- `git_url` points to the AUR git repo that GoReleaser will commit to

**snapcrafts configuration:**
```yaml
snapcrafts:
  - name: azad
    summary: "Beautiful terminal VPN client"
    description: "One command to connect to the fastest VPN server through a stunning terminal interface"
    grade: stable
    confinement: classic
    license: MIT
    publish: true
```

**Key points for snap:**
- `confinement: classic` gives full system access (required for VPN operations: network control, proxy settings, firewall rules)
- Classic confinement requires manual review by Snap Store team (documented in research as taking days/weeks)
- `publish: true` auto-publishes to Snap Store (requires SNAPCRAFT_STORE_CREDENTIALS in CI)
- `grade: stable` marks this as production-ready

Add a YAML comment above the `aurs` section noting that `AUR_KEY` SSH private key must be configured as a CI secret. Add a comment above `snapcrafts` noting that classic confinement requires Snap Store review.
  </action>
  <verify>
    <automated>cd /Users/lee/vless-terminal && grep -q "aurs:" .goreleaser.yaml && grep -q "azad-bin" .goreleaser.yaml && grep -q "snapcrafts:" .goreleaser.yaml && grep -q "classic" .goreleaser.yaml && grep -q "AUR_KEY" .goreleaser.yaml && echo "PASS"</automated>
  </verify>
  <done>AUR PKGBUILD configured with azad-bin package name, SSH key for push, and completion installation. Snap configured with classic confinement for VPN capabilities. Both skip upload during snapshot builds.</done>
</task>

</tasks>

<verification>
- `.goreleaser.yaml` contains `nfpms:` section with both `deb` and `rpm` formats
- nFPM contents install completions to standard Linux paths
- `.goreleaser.yaml` contains `aurs:` section with `azad-bin` package name
- AUR package block installs binary and completions with correct permissions
- `.goreleaser.yaml` contains `snapcrafts:` section with `classic` confinement
- All sections use GoReleaser v2 key naming conventions
</verification>

<success_criteria>
GoReleaser configuration is complete with all Linux package formats: .deb, .rpm, AUR PKGBUILD, and snap. Each format includes proper metadata, shell completions, and conditional upload for snapshot/release builds.
</success_criteria>

<output>
After completion, create `.planning/phases/06-distribution/06-04-SUMMARY.md`
</output>
