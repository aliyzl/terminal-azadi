---
phase: 06-distribution
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .goreleaser.yaml
  - .github/workflows/release.yml
  - scripts/completions.sh
autonomous: true
requirements:
  - DIST-01
  - DIST-06

must_haves:
  truths:
    - "GoReleaser builds azad for macOS (amd64, arm64) and Linux (amd64, arm64) with -s -w ldflags and -trimpath"
    - "GitHub Actions workflow triggers a GoReleaser release on v* tag push"
    - "Release artifacts include SHA256 checksums and SBOM for all archives"
    - "Shell completions (bash, zsh, fish) are generated and included in archives"
  artifacts:
    - path: ".goreleaser.yaml"
      provides: "GoReleaser v2 configuration for builds, archives, checksums, SBOM, changelog, and release"
      contains: "version: 2"
    - path: ".github/workflows/release.yml"
      provides: "GitHub Actions CI workflow for tag-triggered releases"
      contains: "goreleaser/goreleaser-action"
    - path: "scripts/completions.sh"
      provides: "Shell completion generation script using cobra"
      contains: "go run ./cmd/azad completion"
  key_links:
    - from: ".github/workflows/release.yml"
      to: ".goreleaser.yaml"
      via: "goreleaser-action invokes goreleaser release --clean"
      pattern: "goreleaser.*release.*--clean"
    - from: ".goreleaser.yaml"
      to: "scripts/completions.sh"
      via: "before.hooks runs completions script"
      pattern: "./scripts/completions.sh"
    - from: ".goreleaser.yaml"
      to: "cmd/azad/main.go"
      via: "ldflags injects version into main.version"
      pattern: "main.version"
---

<objective>
Set up GoReleaser v2 configuration for cross-platform builds and GitHub Actions release automation.

Purpose: Enable single-binary distribution for macOS and Linux across amd64/arm64 with proper checksums, SBOM, and automated GitHub Releases on tag push.
Output: `.goreleaser.yaml` driving 4-target builds, `release.yml` GitHub Actions workflow, and `completions.sh` for shell completion generation.
</objective>

<execution_context>
@/Users/lee/.claude/get-shit-done/workflows/execute-plan.md
@/Users/lee/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-distribution/06-RESEARCH.md
@cmd/azad/main.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GoReleaser configuration and completions script</name>
  <files>.goreleaser.yaml, scripts/completions.sh</files>
  <action>
Create `.goreleaser.yaml` at the project root with GoReleaser v2 format:

```yaml
version: 2
```

**env section:** Set `CGO_ENABLED=0` (xray-core compiles without CGO).

**before.hooks:** Run `go mod tidy` and `./scripts/completions.sh` to generate shell completions before archiving.

**builds section:** Single build entry `id: azad`:
- `main: ./cmd/azad`
- `binary: azad`
- `flags: [-trimpath]` (prevent local path leakage in binary)
- `ldflags: [-s -w -X main.version={{.Version}}]` (strip debug info, inject version into `var version = "dev"` in main.go)
- `goos: [darwin, linux]`
- `goarch: [amd64, arm64]`

**archives section:** Default archive:
- `name_template: "{{ .ProjectName }}_{{ .Version }}_{{ .Os }}_{{ .Arch }}"`
- `format: tar.gz`
- `files: [LICENSE*, README*, completions/*]`

**checksum section:** `name_template: "checksums.txt"`, `algorithm: sha256`

**sboms section:** `artifacts: archive` (uses Syft for SPDX SBOM generation for each archive)

**changelog section:** Sort ascending, exclude prefixes: `^docs:`, `^test:`, `^ci:`

**release section:** `github: { owner: leejooy96, name: azad }`, `name_template: "Azad v{{.Version}}"`

Then create `scripts/completions.sh`:
```bash
#!/bin/sh
set -e
rm -rf completions
mkdir completions
for sh in bash zsh fish; do
  go run ./cmd/azad completion "$sh" > "completions/azad.$sh"
done
```

Make the script executable: `chmod +x scripts/completions.sh`
  </action>
  <verify>
    <automated>cd /Users/lee/vless-terminal && test -f .goreleaser.yaml && grep -q "version: 2" .goreleaser.yaml && grep -q "CGO_ENABLED=0" .goreleaser.yaml && grep -q "darwin" .goreleaser.yaml && grep -q "linux" .goreleaser.yaml && grep -q "amd64" .goreleaser.yaml && grep -q "arm64" .goreleaser.yaml && grep -q "checksums.txt" .goreleaser.yaml && grep -q "sboms" .goreleaser.yaml && test -x scripts/completions.sh && grep -q "go run ./cmd/azad completion" scripts/completions.sh && echo "PASS"</automated>
  </verify>
  <done>GoReleaser v2 config exists with 4 platform targets (darwin/linux x amd64/arm64), ldflags -s -w with version injection, checksums, SBOM, and completions script is executable</done>
</task>

<task type="auto">
  <name>Task 2: Create GitHub Actions release workflow</name>
  <files>.github/workflows/release.yml</files>
  <action>
Create `.github/workflows/release.yml` with a tag-triggered release workflow:

**Trigger:** `push.tags: ["v*"]` -- fires on any version tag push.

**Permissions:** `contents: write` (upload release assets), `id-token: write` (OIDC for provenance), `attestations: write` (artifact attestation).

**Job: release** on `ubuntu-latest`:
1. `actions/checkout@v4` with `fetch-depth: 0` (GoReleaser needs full history for changelog)
2. `actions/setup-go@v5` with `go-version-file: go.mod` (uses project's Go version)
3. `goreleaser/goreleaser-action@v6` with:
   - `version: "~> v2"` (GoReleaser v2)
   - `args: release --clean`
   - `env: GITHUB_TOKEN: ${{ secrets.GH_PAT }}` (PAT with repo scope needed for Homebrew tap push in later plan; use GITHUB_TOKEN as fallback comment)

Add a comment in the workflow explaining that `GH_PAT` is needed when Homebrew tap is configured (Plan 03), and that `GITHUB_TOKEN` can be used if no cross-repo push is needed.
  </action>
  <verify>
    <automated>cd /Users/lee/vless-terminal && test -f .github/workflows/release.yml && grep -q 'goreleaser/goreleaser-action' .github/workflows/release.yml && grep -q 'v\*' .github/workflows/release.yml && grep -q 'release --clean' .github/workflows/release.yml && grep -q 'fetch-depth: 0' .github/workflows/release.yml && echo "PASS"</automated>
  </verify>
  <done>GitHub Actions workflow triggers GoReleaser on v* tag push with proper Go setup, checkout depth, and token configuration</done>
</task>

</tasks>

<verification>
- `.goreleaser.yaml` exists at project root with `version: 2` header
- Builds configured for darwin+linux x amd64+arm64 with CGO_ENABLED=0
- ldflags include `-s -w -X main.version={{.Version}}` and `-trimpath` flag set
- Checksum file configured as `checksums.txt` with sha256
- SBOM configured with `artifacts: archive`
- `scripts/completions.sh` is executable and generates bash/zsh/fish completions
- `.github/workflows/release.yml` triggers on v* tags with goreleaser-action@v6
- All files reference correct paths (./cmd/azad for build main, main.version for ldflags)
</verification>

<success_criteria>
GoReleaser configuration can drive 4-platform builds with size optimization. GitHub Actions workflow is ready to trigger automated releases on tag push. Shell completions are auto-generated as part of the release process.
</success_criteria>

<output>
After completion, create `.planning/phases/06-distribution/06-01-SUMMARY.md`
</output>
