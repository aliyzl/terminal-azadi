---
phase: 06-distribution
plan: 03
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - scripts/install.sh
  - .goreleaser.yaml
autonomous: true
requirements:
  - DIST-04
  - DIST-05

must_haves:
  truths:
    - "Running curl -sSL <install-url> | bash detects OS/arch and installs the correct azad binary into PATH"
    - "Install script verifies SHA256 checksum of downloaded binary before installing"
    - "Install script works on fresh macOS and Linux machines without non-standard dependencies"
    - "brew install leejooy96/tap/azad installs the binary with shell completions"
  artifacts:
    - path: "scripts/install.sh"
      provides: "POSIX curl-pipe installer with OS/arch detection, checksum verification, PATH placement"
      contains: "uname -s"
    - path: ".goreleaser.yaml"
      provides: "Homebrew tap configuration in brews section"
      contains: "homebrew-tap"
  key_links:
    - from: "scripts/install.sh"
      to: "GitHub Releases"
      via: "Downloads archive from github.com/leejooy96/azad/releases"
      pattern: "github.com/leejooy96/azad/releases"
    - from: ".goreleaser.yaml"
      to: "leejooy96/homebrew-tap"
      via: "brews section pushes formula to tap repo on release"
      pattern: "homebrew-tap"
---

<objective>
Create a curl-pipe install script and configure Homebrew tap formula generation in GoReleaser.

Purpose: Users can install azad with a single command on any macOS or Linux machine -- either `curl -sSL <url> | bash` for universal installation or `brew install leejooy96/tap/azad` for Homebrew users.
Output: POSIX install script with OS/arch detection and checksum verification, GoReleaser brews configuration for auto-generated Homebrew formula.
</objective>

<execution_context>
@/Users/lee/.claude/get-shit-done/workflows/execute-plan.md
@/Users/lee/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-distribution/06-RESEARCH.md
@.planning/phases/06-distribution/06-01-SUMMARY.md
@.goreleaser.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create POSIX curl-pipe install script</name>
  <files>scripts/install.sh</files>
  <action>
Create `scripts/install.sh` -- a POSIX-compatible shell script (#!/bin/sh, not bash) for `curl -sSL <url> | sh` usage.

**Structure:**

```
set -e
```

**Variables:**
- `REPO="leejooy96/azad"` (GitHub repo path)
- `BINARY="azad"` (binary name)

**OS Detection:**
- `OS=$(uname -s | tr '[:upper:]' '[:lower:]')` -- converts to lowercase (darwin, linux)
- Validate OS is darwin or linux; exit 1 with "Unsupported OS" message otherwise

**Arch Detection:**
- `ARCH=$(uname -m)`
- Map: `x86_64` -> `amd64`, `aarch64` -> `arm64`, `arm64` -> `arm64`
- Exit 1 with "Unsupported architecture" for anything else

**Version Detection:**
- Use GitHub API: `VERSION=$(curl -sSL "https://api.github.com/repos/${REPO}/releases/latest" | grep '"tag_name"' | sed -E 's/.*"([^"]+)".*/\1/')` (extracts tag like `v1.0.0`)
- Strip leading `v` for filename: `VERSION_NUM=${VERSION#v}`
- If VERSION is empty, exit with "Failed to detect latest version"

**Download:**
- `FILENAME="${BINARY}_${VERSION_NUM}_${OS}_${ARCH}.tar.gz"`
- `CHECKSUMS="checksums.txt"`
- Download archive to `/tmp/${FILENAME}`: `curl -sSL -o "/tmp/${FILENAME}" "https://github.com/${REPO}/releases/download/${VERSION}/${FILENAME}"`
- Download checksums to `/tmp/${CHECKSUMS}`: `curl -sSL -o "/tmp/${CHECKSUMS}" "https://github.com/${REPO}/releases/download/${VERSION}/${CHECKSUMS}"`

**Checksum Verification:**
- Extract expected checksum: `EXPECTED=$(grep "${FILENAME}" "/tmp/${CHECKSUMS}" | awk '{print $1}')`
- Compute actual checksum: On macOS use `shasum -a 256`, on Linux use `sha256sum`. Assign to `ACTUAL`.
- Compare: if `$EXPECTED` != `$ACTUAL`, print "Checksum verification failed" with both values and exit 1
- Print "Checksum verified" on success

**Installation:**
- Extract to temp dir: `tar -xzf "/tmp/${FILENAME}" -C /tmp "${BINARY}"`
- Try `/usr/local/bin` first: if writable or has sudo, use `install -m 755 "/tmp/${BINARY}" /usr/local/bin/`
- Fallback: `mkdir -p "$HOME/.local/bin" && install -m 755 "/tmp/${BINARY}" "$HOME/.local/bin/"` with a `INSTALL_DIR="$HOME/.local/bin"` variable
- If `/usr/local/bin` is not writable and no sudo: use `$HOME/.local/bin`
- Check if chosen dir is in PATH: `case ":$PATH:" in *":$INSTALL_DIR:"*) ;; *) warn_path=1 ;; esac`
- If `warn_path=1`: print `export PATH="$INSTALL_DIR:$PATH"` instruction

**Cleanup:**
- Remove `/tmp/${FILENAME}`, `/tmp/${CHECKSUMS}`, `/tmp/${BINARY}`

**Success message:**
- Print installed version and location
- Print `Run 'azad --help' to get started`

Make executable: `chmod +x scripts/install.sh`
  </action>
  <verify>
    <automated>cd /Users/lee/vless-terminal && test -x scripts/install.sh && sh -n scripts/install.sh && grep -q 'uname -s' scripts/install.sh && grep -q 'sha256' scripts/install.sh && grep -q '/usr/local/bin' scripts/install.sh && grep -q '.local/bin' scripts/install.sh && echo "PASS"</automated>
    <manual>Read through the script to verify POSIX compatibility (no bashisms like [[ ]] or arrays)</manual>
  </verify>
  <done>Install script detects OS/arch, downloads correct binary from GitHub Releases, verifies SHA256 checksum, installs to PATH with sudo fallback, and prints setup instructions</done>
</task>

<task type="auto">
  <name>Task 2: Add Homebrew tap configuration to GoReleaser</name>
  <files>.goreleaser.yaml</files>
  <action>
Add a `brews` section to the existing `.goreleaser.yaml` (created by Plan 06-01). Append AFTER the `release` section.

**brews configuration (GoReleaser v2 format):**
```yaml
brews:
  - repository:
      owner: leejooy96
      name: homebrew-tap
    directory: Formula
    homepage: https://github.com/leejooy96/azad
    description: "Beautiful terminal VPN client â€” one command to connect to the fastest server"
    license: MIT
    skip_upload: "{{ if .IsSnapshot }}true{{ end }}"
    test: |
      system "#{bin}/azad", "--version"
    extra_install: |-
      bash_completion.install "completions/azad.bash" => "azad"
      zsh_completion.install "completions/azad.zsh" => "_azad"
      fish_completion.install "completions/azad.fish"
```

**Key points:**
- `repository` (not `tap` -- GoReleaser v2 naming): points to `leejooy96/homebrew-tap` which GoReleaser will push to on release
- `directory: Formula` (not `folder` -- GoReleaser v2 naming): standard Homebrew convention
- `skip_upload` is conditional: skips during snapshot builds, uploads during actual releases
- `extra_install` installs shell completions from the archive into Homebrew's completion directories
- `test` block verifies the installed binary works by running `--version`

NOTE: The `GH_PAT` secret in the release workflow must have write access to the `homebrew-tap` repo for the formula push to succeed. This was documented in Plan 06-01's release workflow.
  </action>
  <verify>
    <automated>cd /Users/lee/vless-terminal && grep -q "homebrew-tap" .goreleaser.yaml && grep -q "brews:" .goreleaser.yaml && grep -q "extra_install" .goreleaser.yaml && grep -q "bash_completion" .goreleaser.yaml && echo "PASS"</automated>
  </verify>
  <done>GoReleaser brews section configured to auto-generate and push Homebrew formula to leejooy96/homebrew-tap with shell completions and version test</done>
</task>

</tasks>

<verification>
- `scripts/install.sh` is a valid POSIX shell script (passes `sh -n` syntax check)
- Install script detects OS (darwin/linux) and arch (amd64/arm64)
- Install script downloads from GitHub Releases and verifies SHA256 checksum
- Install script handles sudo/non-sudo installation gracefully
- `.goreleaser.yaml` has `brews` section with correct GoReleaser v2 keys (repository, directory)
- Homebrew formula includes shell completion installation
</verification>

<success_criteria>
Users can install azad with `curl -sSL <url> | sh` on any macOS/Linux machine. Homebrew tap formula is auto-generated on each release with proper completions.
</success_criteria>

<output>
After completion, create `.planning/phases/06-distribution/06-03-SUMMARY.md`
</output>
