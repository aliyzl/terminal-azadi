---
phase: 04-tui-and-server-interaction
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/tui/theme.go
  - internal/tui/keys.go
  - internal/tui/messages.go
  - internal/tui/serverlist.go
  - internal/tui/detail.go
  - internal/tui/statusbar.go
autonomous: true
requirements: [TUI-04, TUI-07, SRVR-01]

must_haves:
  truths:
    - "Color palette uses AdaptiveColor for all themed elements, readable in dark and light terminals"
    - "Server list panel renders servers with name, protocol badge, and latency"
    - "Status bar displays connection state, server name, proxy port, and uptime"
    - "All keybindings are defined in a central keyMap struct implementing help.KeyMap interface"
  artifacts:
    - path: "internal/tui/theme.go"
      provides: "Theme struct with AdaptiveColor fields and DefaultTheme"
      contains: "AdaptiveColor"
    - path: "internal/tui/keys.go"
      provides: "keyMap struct with all keybindings, ShortHelp/FullHelp methods"
      contains: "ShortHelp"
    - path: "internal/tui/messages.go"
      provides: "Custom message types for TUI async operations"
      contains: "pingResultMsg"
    - path: "internal/tui/serverlist.go"
      provides: "serverItem implementing list.DefaultItem, list wrapping bubbles/list"
      contains: "FilterValue"
    - path: "internal/tui/detail.go"
      provides: "Detail panel rendering selected server info"
      contains: "detailModel"
    - path: "internal/tui/statusbar.go"
      provides: "Status bar with connection state, server, port, uptime"
      contains: "statusBarModel"
  key_links:
    - from: "internal/tui/serverlist.go"
      to: "internal/protocol/server.go"
      via: "serverItem wraps protocol.Server"
      pattern: "protocol\\.Server"
    - from: "internal/tui/statusbar.go"
      to: "internal/engine/engine.go"
      via: "reads ConnectionStatus enum"
      pattern: "engine\\.ConnectionStatus"
---

<objective>
Create the TUI visual foundation: theme system with adaptive colors, centralized keybindings, custom message types, and all child components (server list panel, detail panel, status bar).

Purpose: These are the building blocks that the root model (Plan 02) will compose into a layout. Establishing them first enables parallel development of the interactive shell.

Output: Six new files in `internal/tui/` providing typed components ready for composition.
</objective>

<execution_context>
@/Users/lee/.claude/get-shit-done/workflows/execute-plan.md
@/Users/lee/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-tui-and-server-interaction/04-RESEARCH.md

@internal/protocol/server.go
@internal/engine/engine.go
@internal/config/config.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TUI foundation types (theme, keys, messages)</name>
  <files>internal/tui/theme.go, internal/tui/keys.go, internal/tui/messages.go</files>
  <action>
Install the v2 Charmbracelet dependencies:
```bash
cd /Users/lee/vless-terminal && go get charm.land/bubbletea/v2@v2.0.0 charm.land/lipgloss/v2@v2.0.0 charm.land/bubbles/v2@v2.0.0
```

Create `internal/tui/theme.go`:
- Package `tui`
- Define `Theme` struct with `lipgloss.AdaptiveColor` fields: Primary, Secondary, Accent, Muted, Success, Warning, Error, Border, StatusBar, StatusBarText
- Create `var DefaultTheme = Theme{...}` using the color values from the research (Pattern 3)
- Define named lipgloss styles that reference the theme: `titleStyle`, `selectedStyle`, `normalStyle`, `dimStyle`, `protocolBadgeStyle`, `statusBarStyle`
- Use `lipgloss.NewStyle()` with `.Foreground()`, `.Background()`, `.Bold()`, `.Padding()` etc.

Create `internal/tui/keys.go`:
- Define `keyMap` struct with `key.Binding` fields: Up, Down, Select, Back, Quit, Help, Filter, PingAll, AddServer, AddSub, RefreshSub, Delete, ClearAll, Connect
- Create `defaultKeyMap()` returning populated keyMap using `key.NewBinding(key.WithKeys(...), key.WithHelp(...))`
- Follow the exact key assignments from research Pattern (Help section): j/k navigate, enter connect, esc back, q quit, ? help, / filter, p ping all, a add server, s add subscription, r refresh, d delete, D clear all
- Implement `ShortHelp() []key.Binding` and `FullHelp() [][]key.Binding` on keyMap to satisfy the `help.KeyMap` interface

Create `internal/tui/messages.go`:
- Define custom Bubble Tea message types used across the TUI:
  - `pingStartMsg struct{ Total int }` — ping batch started
  - `pingResultMsg struct{ ServerID string; LatencyMs int; Err error }` — single ping result
  - `allPingsCompleteMsg struct{}` — all pings finished
  - `serverAddedMsg struct{ Server protocol.Server }` — server added successfully
  - `serverRemovedMsg struct{ ServerID string }` — server removed
  - `serversReplacedMsg struct{ Count int }` — subscription servers replaced
  - `subscriptionFetchedMsg struct{ Servers []protocol.Server; Err error }` — subscription fetch result
  - `connectResultMsg struct{ Err error }` — connection attempt result
  - `disconnectMsg struct{}` — disconnection requested
  - `tickMsg time.Time` — uptime tick
  - `errMsg struct{ Err error }` — generic error

Import `charm.land/bubbles/v2/key` for key.Binding, `charm.land/lipgloss/v2` for styles, and `github.com/leejooy96/azad/internal/protocol` for Server type in messages.
  </action>
  <verify>
    <automated>cd /Users/lee/vless-terminal && go build ./internal/tui/...</automated>
    <manual>Check that theme.go exports DefaultTheme, keys.go exports defaultKeyMap(), messages.go has all message types</manual>
  </verify>
  <done>Three foundation files compile. Theme has AdaptiveColor for all color slots. keyMap implements help.KeyMap interface with ShortHelp/FullHelp. All custom message types defined.</done>
</task>

<task type="auto">
  <name>Task 2: Create server list panel with fuzzy filtering</name>
  <files>internal/tui/serverlist.go</files>
  <action>
Create `internal/tui/serverlist.go`:

Define `serverItem` struct wrapping `protocol.Server`:
```go
type serverItem struct {
    server protocol.Server
}
```
Implement the `list.DefaultItem` interface (Title, Description, FilterValue):
- `Title()` returns `s.server.Name`
- `Description()` returns protocol badge + latency (e.g., "vless | 42ms" or just "vless" if no latency)
- `FilterValue()` returns `s.server.Name + " " + s.server.Address + " " + string(s.server.Protocol)` — enables fuzzy search by name, address, and protocol (TUI-03)

Define helper function `serversToItems(servers []protocol.Server) []list.Item` that converts a slice of servers to list items.

Define helper function `newServerList(items []list.Item, width, height int) list.Model`:
- Create list via `list.New(items)` (v2 API — takes only items)
- Call `l.SetSize(width, height)`
- Call `l.SetFilteringEnabled(true)` to enable built-in fuzzy search
- Set title: `l.Title = "Servers"`
- Style the list title using theme styles
- Return the configured list model

NOTE on v2 API: The list.New constructor in bubbles v2 takes only items. Use SetSize() and SetDelegate() separately. If the compiler rejects `list.New(items)`, check `go doc charm.land/bubbles/v2/list New` for the exact signature and adapt accordingly. The key constraint is: do NOT use the v1 four-argument constructor.
  </action>
  <verify>
    <automated>cd /Users/lee/vless-terminal && go build ./internal/tui/...</automated>
    <manual>Verify serverItem implements list.DefaultItem interface (Title, Description, FilterValue methods present)</manual>
  </verify>
  <done>serverItem wraps protocol.Server and implements list.DefaultItem with fuzzy-searchable FilterValue. newServerList creates a configured list.Model with filtering enabled.</done>
</task>

<task type="auto">
  <name>Task 3: Create detail panel and status bar components</name>
  <files>internal/tui/detail.go, internal/tui/statusbar.go</files>
  <action>
Create `internal/tui/detail.go`:

Define `detailModel` struct:
- Fields: `server *protocol.Server`, `width int`, `height int`
- `SetServer(srv *protocol.Server)` — updates displayed server
- `SetSize(w, h int)` — updates dimensions
- `View() string` — renders server detail panel content

The View() method renders:
- If no server selected: centered "No server selected" message in muted style
- If server selected: formatted display showing:
  - Server name (bold, accent color)
  - Protocol badge
  - Address:Port
  - Transport (network type, path if websocket/grpc)
  - TLS info (TLS mode, SNI, fingerprint if REALITY)
  - Subscription source (if any)
  - Last connected timestamp (if any)
  - Latency (if measured)
- Use `lipgloss.NewStyle().Width(m.width).Height(m.height)` to constrain rendering to allocated space
- Use theme styles for consistent colors

Create `internal/tui/statusbar.go`:

Define `statusBarModel` struct:
- Fields: `status engine.ConnectionStatus`, `serverName string`, `socksPort int`, `connectedAt time.Time`, `width int`
- `Update(status engine.ConnectionStatus, name string, port int)` — refreshes displayed state
- `SetConnectedAt(t time.Time)` — marks connection start for uptime
- `SetSize(w int)` — updates width
- `View() string` — renders status bar

The View() method renders a single-line bar spanning full width:
- Connection status indicator (colored: green for connected, yellow for connecting, red for error, dim for disconnected)
- Current server name (or "No server" if disconnected)
- Proxy port info: "SOCKS5:{port}"
- Uptime: duration since connectedAt (only when connected), formatted as "0h 0m 0s"
- Use `lipgloss.JoinHorizontal(lipgloss.Center, ...)` to compose sections
- Background color via `statusBarStyle` from theme
- Constrain to width with padding

Import `engine.ConnectionStatus` for the status enum — reference the type, don't create a new one.
  </action>
  <verify>
    <automated>cd /Users/lee/vless-terminal && go build ./internal/tui/...</automated>
    <manual>Verify detailModel.View() handles nil server case. Verify statusBarModel.View() shows all four info sections.</manual>
  </verify>
  <done>Detail panel renders full server info when selected or "No server selected" placeholder. Status bar renders connection state, server name, proxy port, and uptime in a styled single-line bar.</done>
</task>

</tasks>

<verification>
All six files in `internal/tui/` compile:
```bash
cd /Users/lee/vless-terminal && go build ./internal/tui/...
```

Verify the v2 dependencies were added to go.mod:
```bash
grep 'charm.land' go.mod
```

Run full project build to confirm no breakage:
```bash
cd /Users/lee/vless-terminal && go build ./...
```
</verification>

<success_criteria>
- Six new files exist: theme.go, keys.go, messages.go, serverlist.go, detail.go, statusbar.go
- All files compile with `go build ./internal/tui/...`
- Theme uses AdaptiveColor throughout (no hardcoded ANSI)
- keyMap satisfies help.KeyMap interface
- serverItem satisfies list.DefaultItem interface with fuzzy FilterValue
- Status bar renders all four info sections (status, server, port, uptime)
- Full project builds: `go build ./...`
</success_criteria>

<output>
After completion, create `.planning/phases/04-tui-and-server-interaction/04-01-SUMMARY.md`
</output>
