---
phase: 05-quick-connect
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/serverstore/store.go
  - internal/cli/connect.go
autonomous: true
requirements:
  - QCON-02
  - QCON-03

must_haves:
  truths:
    - "Running `azad connect` with no args saves LastUsed to config after successful connection"
    - "Running `azad connect` with no args and no LastUsed selects server with lowest stored LatencyMs"
    - "Connected server's LastConnected timestamp is updated in the server store"
    - "Shared resolveServer function resolves last-used > lowest-latency > first-server"
  artifacts:
    - path: "internal/serverstore/store.go"
      provides: "UpdateServer method for in-place server updates with atomic save"
      contains: "func (s *Store) UpdateServer"
    - path: "internal/cli/connect.go"
      provides: "Enhanced findServer with latency fallback, LastUsed + LastConnected persistence"
      contains: "LatencyMs"
  key_links:
    - from: "internal/cli/connect.go"
      to: "internal/config/config.go"
      via: "config.Save after successful connection"
      pattern: "config\\.Save"
    - from: "internal/cli/connect.go"
      to: "internal/serverstore/store.go"
      via: "store.UpdateServer for LastConnected"
      pattern: "store\\.UpdateServer"
---

<objective>
Add server resolution with latency fallback and persist connection preferences in the headless connect flow.

Purpose: QCON-02 requires headless connect to remember servers; QCON-03 requires preferences to persist between sessions. The existing `findServer` lacks a latency fallback strategy, and `runConnect` does not save `LastUsed` or update `LastConnected` after connection.

Output: Enhanced `findServer` with latency-aware fallback, `UpdateServer` on the store, and headless connect that saves preferences after successful connection.
</objective>

<execution_context>
@/Users/lee/.claude/get-shit-done/workflows/execute-plan.md
@/Users/lee/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-quick-connect/05-RESEARCH.md
@internal/cli/connect.go
@internal/serverstore/store.go
@internal/config/config.go
@internal/protocol/server.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add UpdateServer to store and enhance findServer with latency fallback</name>
  <files>internal/serverstore/store.go, internal/cli/connect.go</files>
  <action>
1. In `internal/serverstore/store.go`, add an `UpdateServer` method:
   ```go
   func (s *Store) UpdateServer(updated protocol.Server) error {
       s.mu.Lock()
       defer s.mu.Unlock()
       for i := range s.servers {
           if s.servers[i].ID == updated.ID {
               s.servers[i] = updated
               return s.save()
           }
       }
       return fmt.Errorf("server %q not found", updated.ID)
   }
   ```
   Place it after `FindByID` for logical grouping with read/write by ID methods.

2. In `internal/cli/connect.go`, enhance `findServer` to add a latency fallback between "last-used" and "first server":
   - After the `cfg.Server.LastUsed` check fails/falls through, iterate `servers` to find the one with the lowest positive `LatencyMs` (> 0).
   - If found, return that server.
   - Otherwise fall through to the existing `return &servers[0]` fallback.
   - The function signature stays the same: `func findServer(store *serverstore.Store, cfg *config.Config, args []string) (*protocol.Server, error)`.
   - Resolution order: explicit name/ID arg > LastUsed > lowest LatencyMs > first server.
  </action>
  <verify>
    <automated>cd /Users/lee/vless-terminal && go build ./...</automated>
    <manual>Verify UpdateServer is added to store.go and findServer now has 4-tier resolution</manual>
  </verify>
  <done>UpdateServer method exists on Store; findServer resolution order is: explicit arg > LastUsed > lowest LatencyMs > first server</done>
</task>

<task type="auto">
  <name>Task 2: Persist LastUsed and LastConnected after headless connect</name>
  <files>internal/cli/connect.go</files>
  <action>
In `runConnect` in `internal/cli/connect.go`, add preference persistence after the successful `eng.Start()` call and before the `<-ctx.Done()` wait. Place this block after the IP verification output and before the "Press Ctrl+C" status line:

1. Save LastUsed to config:
   ```go
   cfg.Server.LastUsed = server.ID
   if err := config.Save(cfg, configPath); err != nil {
       fmt.Printf("Warning: could not save config: %v\n", err)
   }
   ```
   `configPath` is already in scope from the top of `runConnect`.

2. Update LastConnected on the server in the store:
   ```go
   server.LastConnected = time.Now()
   if err := store.UpdateServer(*server); err != nil {
       fmt.Printf("Warning: could not update server: %v\n", err)
   }
   ```
   This requires adding `"time"` to the import block in connect.go.

Both are warnings-only (non-fatal) since the connection is already established and working. The primary function of `runConnect` (proxying traffic) should not fail due to preference persistence issues.
  </action>
  <verify>
    <automated>cd /Users/lee/vless-terminal && go build ./... && go vet ./...</automated>
    <manual>Read connect.go and verify config.Save and store.UpdateServer calls exist after eng.Start block</manual>
  </verify>
  <done>After headless connect succeeds: LastUsed saved to config.yaml, LastConnected updated on server in store. Both are warning-only on failure.</done>
</task>

</tasks>

<verification>
- `go build ./...` compiles without errors
- `go vet ./...` reports no issues
- `findServer` contains 4-tier resolution: explicit arg > LastUsed > lowest LatencyMs > first
- `runConnect` calls `config.Save` and `store.UpdateServer` after successful connection
- `UpdateServer` method exists on `serverstore.Store`
</verification>

<success_criteria>
- Headless `azad connect` saves preferences after successful connection
- Server resolution includes latency-aware fallback for smarter server selection
- Store supports in-place server updates via `UpdateServer`
- All code compiles and passes vet
</success_criteria>

<output>
After completion, create `.planning/phases/05-quick-connect/05-01-SUMMARY.md`
</output>
