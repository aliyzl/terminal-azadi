---
phase: 04-tui-and-server-interaction
plan: 04
type: execute
wave: 1
depends_on: ["04-03"]
files_modified: [internal/tui/app.go]
autonomous: true
gap_closure: true
requirements: [SRVR-02, SRVR-03]

must_haves:
  truths:
    - "User can paste a server URI (Cmd+V / Ctrl+V) into the add-server input modal and it appears in the text field"
    - "User can paste a subscription URL (Cmd+V / Ctrl+V) into the add-subscription input modal and it appears in the text field"
  artifacts:
    - path: "internal/tui/app.go"
      provides: "View-aware message routing in Update() and explicit tea.PasteMsg handling"
      contains: "tea.PasteMsg"
  key_links:
    - from: "internal/tui/app.go"
      to: "internal/tui/input.go"
      via: "tea.PasteMsg forwarded to m.input.Update(msg) when view is viewAddServer or viewAddSubscription"
      pattern: "case tea\\.PasteMsg"
    - from: "internal/tui/app.go"
      to: "internal/tui/input.go"
      via: "Default fallthrough routes unhandled messages to m.input when in input view states"
      pattern: "m\\.input\\.Update\\(msg\\)"
---

<objective>
Fix paste (Cmd+V / Ctrl+V) in TUI text input modals for add-server and add-subscription.

Purpose: UAT tests 5 and 6 failed because pasting does not work in the input modals. The debug session (.planning/debug/paste-not-working.md) diagnosed two bugs in app.go: (1) tea.PasteMsg has no case in Update() and falls through to serverList instead of input, and (2) the default fallthrough always routes to serverList regardless of which child model is active. Both bugs prevent the textinput from receiving paste content.

Output: A patched internal/tui/app.go where paste works in both add-server and add-subscription modals.
</objective>

<execution_context>
@/Users/lee/.claude/get-shit-done/workflows/execute-plan.md
@/Users/lee/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/debug/paste-not-working.md
@.planning/phases/04-tui-and-server-interaction/04-03-SUMMARY.md
@internal/tui/app.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix message routing in app.go to support paste in input modals</name>
  <files>internal/tui/app.go</files>
  <action>
Apply two targeted changes to the root model's Update() method in internal/tui/app.go. Both changes fix message routing so that the textinput in the input modal receives paste content.

**Change 1: Add explicit tea.PasteMsg case (insert between the errMsg case and the tea.KeyPressMsg case, around line 200).**

Add this case to the type switch:

```go
case tea.PasteMsg:
    if m.view == viewAddServer || m.view == viewAddSubscription {
        var cmd tea.Cmd
        m.input, cmd = m.input.Update(msg)
        return m, cmd
    }
    return m, nil
```

This routes bracketed paste content (Cmd+V on macOS, Ctrl+Shift+V on Linux, or any terminal paste) directly to the input model when an input modal is active.

**Change 2: Make the default fallthrough (currently lines 205-212) view-aware.**

Replace the current default block:

```go
// Pass other messages to the server list
var cmd tea.Cmd
m.serverList, cmd = m.serverList.Update(msg)
if cmd != nil {
    cmds = append(cmds, cmd)
}
return m, tea.Batch(cmds...)
```

With a view-aware fallthrough:

```go
// Pass other messages to the active child model based on view state
var cmd tea.Cmd
if m.view == viewAddServer || m.view == viewAddSubscription {
    m.input, cmd = m.input.Update(msg)
} else {
    m.serverList, cmd = m.serverList.Update(msg)
}
if cmd != nil {
    cmds = append(cmds, cmd)
}
return m, tea.Batch(cmds...)
```

This ensures that internal clipboard command results (pasteMsg / pasteErrMsg from the textinput package, which are unexported types the root model cannot match explicitly) are forwarded to the input model instead of the server list when an input modal is active. This fixes the Ctrl+V path where textinput issues a Paste command that reads from the system clipboard and produces an internal pasteMsg.

**Why both changes are needed:**
- Change 1 handles the PRIMARY paste path: terminal bracketed paste (tea.PasteMsg) -- this is what Cmd+V produces on macOS.
- Change 2 handles the SECONDARY paste path: Ctrl+V triggers textinput's clipboard-read command, which returns an internal pasteMsg that must be routed back to textinput.

Do NOT modify handleKeyPress -- it already correctly routes tea.KeyPressMsg to the input model for input view states. Only modify the Update() type switch and its default fallthrough.
  </action>
  <verify>
    <automated>cd /Users/lee/vless-terminal && go build ./... && go test ./...</automated>
    <manual>Run `go run ./cmd/azad/`, press 'a' to open add-server modal, paste a URI with Cmd+V. Text should appear in the input field. Press Esc, then 's' for add-subscription, paste a URL. Text should appear.</manual>
  </verify>
  <done>
    - tea.PasteMsg case exists in Update() that routes to m.input when view is viewAddServer or viewAddSubscription
    - Default fallthrough routes unhandled messages to m.input (not m.serverList) when in input view states
    - Project builds cleanly (go build ./...)
    - All existing tests pass (go test ./...)
    - Paste works in both add-server and add-subscription modals (human confirmation in UAT re-test)
  </done>
</task>

</tasks>

<verification>
1. `go build ./...` compiles without errors
2. `go test ./...` all tests pass
3. `grep -n "tea.PasteMsg" internal/tui/app.go` returns the new case
4. `grep -n "m.input, cmd = m.input.Update(msg)" internal/tui/app.go` shows routing in both the PasteMsg case and the default fallthrough
</verification>

<success_criteria>
- Paste (Cmd+V) inserts text into the add-server input modal (UAT test 5 passes)
- Paste (Cmd+V) inserts text into the add-subscription input modal (UAT test 6 passes)
- No regression in existing functionality (build + tests pass)
</success_criteria>

<output>
After completion, create `.planning/phases/04-tui-and-server-interaction/04-04-SUMMARY.md`
</output>
